<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Robot Head Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ensure the page is not zoomable and fits the screen */
        body, html {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }
        /* Custom style for video elements */
        video {
            width: 100%;
            background: #222;
            border-radius: 0.5rem;
            transform: scaleX(-1); /* Mirror local video */
        }
        #remoteVideo {
            transform: scaleX(1); /* Don't mirror remote video */
        }
        /* Make text areas readable */
        textarea {
            font-family: monospace;
            font-size: 0.8rem;
            color: #eee;
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 h-full flex flex-col p-4 md:p-8 gap-4 overflow-hidden">
    <h1 class="text-3xl font-bold text-center">Robot Head Telepresence</h1>

    <div class="flex-1 flex flex-col md:flex-row gap-4 overflow-hidden">
        
        <div class="flex-1 flex flex-col gap-4 overflow-hidden">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex-1 flex flex-col">
                <h2 class="text-xl font-semibold mb-2">Robot View</h2>
                <div class="aspect-video w-full rounded-lg bg-gray-700 flex-1">
                    <video id="remoteVideo" autoplay playsinline></video>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex-1 flex flex-col">
                <h2 class="text-xl font-semibold mb-2">Your View</h2>
                <div class="aspect-video w-full rounded-lg bg-gray-700 flex-1">
                    <video id="localVideo" autoplay muted playsinline></video>
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col gap-4 overflow-y-auto">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-2">1. Controller (ESP32)</h3>
                <button id="connectBluetooth" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Connect to Controller (Bluetooth)
                </button>
                <div class="mt-2 p-2 h-32 bg-gray-200 dark:bg-gray-700 rounded overflow-auto">
                    <pre id="controllerData" class="text-sm">Waiting for controller...</pre>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-2">2. Robot (Raspberry Pi)</h3>
                <button id="connectWebRTC" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Start Robot Connection (WebRTC)
                </button>
                <div id="webRtcStatus" class="mt-2 text-center text-sm">WebRTC Inactive</div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex-1 flex flex-col overflow-hidden">
                <h3 class="text-lg font-semibold mb-2">3. Manual Signaling</h3>
                <p class="text-sm mb-2 text-gray-600 dark:text-gray-400">
                    1. Click 'Start Robot Connection'.<br>
                    2. Copy 'Web App Offer' -> Paste into Robot terminal.<br>
                    3. Copy 'Web App ICE Candidates' -> Paste into Robot terminal (one per line, then a blank line).<br>
                    4. Copy 'Robot's Answer' -> Paste here -> Click 'Submit Answer'.<br>
                    5. Copy 'Robot's ICE Candidates' -> Paste one here -> Click 'Add Candidate'.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-1 overflow-y-auto">
                    <div class="flex flex-col gap-2">
                        <div>
                            <label for="sdpOffer" class="font-medium">Web App Offer (Copy):</label>
                            <textarea id="sdpOffer" rows="4" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"></textarea>
                        </div>
                        <div>
                            <label for="webAppIceCandidates" class="font-medium">Web App ICEs (Copy):</label>
                            <textarea id="webAppIceCandidates" rows="6" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"></textarea>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2">
                        <div>
                            <label for="sdpAnswer" class="font-medium">Robot's Answer (Paste):</label>
                            <textarea id="sdpAnswer" rows="4" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"></textarea>
                            <button id="submitAnswer" class="mt-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Submit Answer
                            </button>
                        </div>
                        <div>
                            <label for="robotIceCandidateInput" class="font-medium">Robot's ICE (Paste):</label>
                            <textarea id="robotIceCandidateInput" rows="2" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"></textarea>
                            <button id="addRobotIceCandidate" class="mt-2 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Add Robot Candidate
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const controllerDataEl = document.getElementById('controllerData');
        const webRtcStatusEl = document.getElementById('webRtcStatus');
        const localVideoEl = document.getElementById('localVideo');
        const remoteVideoEl = document.getElementById('remoteVideo');

        // WebRTC Globals
        let peerConnection;
        let dataChannel;
        let localStream;
        
        const iceConfiguration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }, // Google's public STUN server
            ]
        };

        // --- 1. Bluetooth Controller Logic ---
        document.getElementById('connectBluetooth').addEventListener('click', async () => {
            controllerDataEl.textContent = 'Scanning for devices...';

            // --- UUIDs MUST match your ESP32 code ---
            const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
            const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

            try {
                // Filter for *only* your controller's service
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }]
                });

                controllerDataEl.textContent = `Connecting to ${device.name}...`;
                const server = await device.gatt.connect();

                controllerDataEl.textContent = 'Getting service...';
                const service = await server.getPrimaryService(SERVICE_UUID);
                
                controllerDataEl.textContent = 'Getting characteristic...';
                const characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                controllerDataEl.textContent = 'Starting notifications...';
                await characteristic.startNotifications();
                
                characteristic.addEventListener('characteristicvaluechanged', (event) => {
                    const value = event.target.value; // This is a DataView
                    
                    // --- Parse your ESP32 data struct ---
                    // struct ControlData {
                    //   int8_t  joy1_x; // 1 byte
                    //   int8_t  joy1_y; // 1 byte
                    //   int8_t  joy2_x; // 1 byte
                    //   int8_t  joy2_y; // 1 byte
                    //   uint8_t switches; // 1 byte
                    // };
                    if (value.byteLength < 5) return; // Not our data packet

                    const joy1_x = value.getInt8(0);
                    const joy1_y = value.getInt8(1);
                    const joy2_x = value.getInt8(2);
                    const joy2_y = value.getInt8(3);
                    const switches = value.getUint8(4);

                    // Display the data
                    const dataString = `Joy1 X: ${joy1_x}\nJoy1 Y: ${joy1_y}\nJoy2 X: ${joy2_x}\nJoy2 Y: ${joy2_y}\nSW: ${switches}`;
                    controllerDataEl.textContent = dataString;

                    // Create the JSON object to send to the robot
                    const controlPacket = {
                        j1: { x: joy1_x, y: joy1_y },
                        j2: { x: joy2_x, y: joy2_y },
                        sw: switches
                    };

                    // --- Send data over WebRTC Data Channel ---
                    if (dataChannel && dataChannel.readyState === 'open') {
                       // Send the full control packet as a JSON string
                       dataChannel.send(JSON.stringify(controlPacket));
                    }
                });

            } catch (error) {
                console.error('Bluetooth Error:', error);
                controllerDataEl.textContent = `Error: ${error.message}`;
            }
        });

        // --- 2. WebRTC Connection Logic ---
        document.getElementById('connectWebRTC').addEventListener('click', async () => {
            webRtcStatusEl.textContent = 'Starting...';

            try {
                // Get local camera and microphone
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideoEl.srcObject = localStream;

                webRtcStatusEl.textContent = 'Got local stream. Creating connection...';
                
                peerConnection = new RTCPeerConnection(iceConfiguration);

                // Add local tracks to the connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Handle incoming remote stream
                peerConnection.ontrack = (event) => {
                    webRtcStatusEl.textContent = 'Receiving remote stream!';
                    if (!remoteVideoEl.srcObject) {
                        remoteVideoEl.srcObject = event.streams[0];
                    }
                };

                // Create the Data Channel (for controls)
                // This MUST match the label on the Pi ('controls')
                dataChannel = peerConnection.createDataChannel('controls', { ordered: false, maxRetransmits: 0 });
                dataChannel.onopen = () => webRtcStatusEl.textContent = 'Data channel OPEN';
                dataChannel.onclose = () => webRtcStatusEl.textContent = 'Data channel CLOSED';
                dataChannel.onerror = (err) => console.error('Data channel error:', err);

                // Handle ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        const webAppIceEl = document.getElementById('webAppIceCandidates');
                        webAppIceEl.value += JSON.stringify(event.candidate.toJSON()) + '\n';
                    }
                };

                // Create SDP Offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                // Display the offer for copy-pasting
                document.getElementById('sdpOffer').value = JSON.stringify(peerConnection.localDescription);
                webRtcStatusEl.textContent = 'Offer created. Copy to robot.';

            } catch (error) {
                console.error('WebRTC Error:', error);
                webRtcStatusEl.textContent = `Error: ${error.message}`;
            }
        });

        // --- 3. Handle Robot's Answer ---
        document.getElementById('submitAnswer').addEventListener('click', async () => {
            const answerJson = document.getElementById('sdpAnswer').value;
            if (!peerConnection || !answerJson) {
                webRtcStatusEl.textContent = 'Error: Connection not started or answer is empty.';
                return;
            }

            try {
                const answer = JSON.parse(answerJson);
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                webRtcStatusEl.textContent = 'Remote answer set! Connection pending...';

            } catch (error) {
                console.error('Answer Error:', error);
                webRtcStatusEl.textContent = `Answer Error: ${error.message}`;
            }
        });

        // --- 4. Handle Robot's ICE Candidates ---
        document.getElementById('addRobotIceCandidate').addEventListener('click', async () => {
            const candidateJson = document.getElementById('robotIceCandidateInput').value;
            if (!peerConnection || !candidateJson.trim()) {
                webRtcStatusEl.textContent = 'Error: Connection not started or candidate is empty.';
                return;
            }

            try {
                const candidate = JSON.parse(candidateJson);
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                webRtcStatusEl.textContent = 'Added robot ICE candidate.';
                document.getElementById('robotIceCandidateInput').value = ''; // Clear for next one
            } catch (error) {
                console.error('Add ICE Error:', error);
                webRtcStatusEl.textContent = `Add ICE Error: ${error.message}`;
            }
        });

    </script>
</body>
</html>